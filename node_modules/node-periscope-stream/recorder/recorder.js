var ffmpeg = require('fluent-ffmpeg');
var Twit = require('twit');
var request = require('request');

var T = new Twit({
    consumer_key:         '',
    consumer_secret:      '',
    access_token:         '',
    access_token_secret:  ''
});

var userID = 265363897;

var stream = T.stream('statuses/filter', { follow: [userID] });

stream.on('tweet', function (tweet) {
	if (!tweet.entities.urls || !tweet.entities.urls.length) {
		return;
	}
	
	var periscopeUrl = tweet.entities.urls[0].expanded_url;
	var match = periscopeUrl.match(/periscope.tv\/w\/(.*)/i);
	
	if (!match) {
		return;
	}
	
	var id = match[1];
	
	var api = 'https://api.periscope.tv/api/v2/getAccessPublic?token=' + id;
	
	request(api, function(error, response, body) {
		if (error || response.statusCode != 200) {
			console.log(response.statusCode);
			return;
		}
		
		var obj = JSON.parse(body);
		var hls = obj['hls_url'];
		
		ffmpeg(hls)
			.on('error', function(err) { console.log(err.message) })
			.output(userID + '-' + Math.round(Date.now() / 1000) + '.mp4')
			.run();
	});
});
